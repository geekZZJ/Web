<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>多物体弹动</title>
    <style>
      body,
      html {
        margin: 0;
        height: 100%;
      }
      #canvas {
        background-color: #000;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <script src="../components//Ball.js"></script>
    <script src="../utils.js"></script>
    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      const W = (canvas.width = 1200);
      const H = (canvas.height = 800);

      let spring = 0.03;
      const mouse = c.getOffset(canvas);
      let ball1_dragging = false;
      let ball2_dragging = false;
      const springLength = 200;
      const friction = 0.9;

      const ball1 = new Ball({
        x: c.rp([50, W - 50]),
        y: c.rp([50, H - 50]),
        r: 20,
      });

      const ball2 = new Ball({
        x: c.rp([50, W - 50]),
        y: c.rp([50, H - 50]),
        r: 20,
      });

      canvas.addEventListener("mousedown", () => {
        if (ball1.isPoint(mouse)) {
          ball1_dragging = true;
        }
        if (ball2.isPoint(mouse)) {
          ball2_dragging = true;
        }
      });

      canvas.addEventListener("mousemove", () => {
        if (ball1_dragging) {
          ball1.x = mouse.x;
          ball1.y = mouse.y;
        }
        if (ball2_dragging) {
          ball2.x = mouse.x;
          ball2.y = mouse.y;
        }
      });

      canvas.addEventListener("mouseup", () => {
        ball1_dragging = ball2_dragging = false;
      });

      function springTo(b1, b2) {
        const dx = b2.x - b1.x;
        const dy = b2.y - b1.y;
        const angle = Math.atan2(dy, dx);
        let targetX = b2.x - springLength * Math.cos(angle);
        let targetY = b2.y - springLength * Math.cos(angle);

        b1.vx += (targetX - b1.x) * spring;
        b1.vy += (targetY - b1.y) * spring;
        b1.vx *= friction;
        b1.vy *= friction;

        b1.x += b1.vx;
        b1.y += b1.vy;
      }

      function drawFrame() {
        window.requestAnimationFrame(drawFrame);
        ctx.clearRect(0, 0, W, H);

        if (!ball1_dragging) {
          springTo(ball1, ball2);
        }

        if (!ball2_dragging) {
          springTo(ball2, ball1);
        }

        ctx.beginPath();
        ctx.lineWidth = 3;
        ctx.strokeStyle = "rgb(255,255,255)";
        ctx.lineTo(ball1.x, ball1.y);
        ctx.lineTo(ball2.x, ball2.y);
        ctx.stroke();

        ball1.render(ctx);
        ball2.render(ctx);
      }

      drawFrame();
    </script>
  </body>
</html>
